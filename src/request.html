<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create request — Escalatex</title>
  <link rel="icon" href="/logo.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo img"><img alt="Escalatex" src="/logo.svg" /></div>
        <div>
          <div class="h1">Create an escalation request</div>
          <div class="tag" id="endpointTag">Loading…</div>
        </div>
      </div>
      <div class="row">
        <a class="btn ghost" id="backBtn" href="/">Back</a>
        <a class="btn" id="profileBtn" href="/">Provider</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <form id="form">
          <label>Subject</label>
          <input id="subject" required maxlength="200" placeholder="e.g. Urgent: payments failing on checkout" />

          <label>Details</label>
          <textarea id="details" required maxlength="10000" placeholder="Context, links, logs, expected behavior, constraints…"></textarea>

          <label>Tier</label>
          <select id="tier"></select>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="submitBtn" type="submit">Submit request</button>
            <button class="btn ghost" id="resetBtn" type="button">Reset</button>
          </div>

          <div id="status" style="margin-top:12px"></div>
        </form>
      </div>

      <div class="card">
        <div class="h1" style="font-size:16px;margin-bottom:8px">Payment</div>
        <div id="payBox" class="alert">
          <div class="small">Submit a request to get a payment link/quote.</div>
        </div>
        <div style="height:10px"></div>
        <div class="h1" style="font-size:16px;margin-bottom:8px">Receipt</div>
        <div id="receiptBox" class="alert">
          <div class="small">Receipt link will appear after submit.</div>
        </div>
      </div>
    </div>

    <div class="footer">Tip: after payment, click “Check payment” — or paste a tx signature and confirm.</div>
  </div>

<script>
  const qs = new URLSearchParams(location.search);
  const handle = qs.get('handle') || '';
  const baseUrl = location.origin;

  function esc(s){return String(s).replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
  function uuid(){ return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + '-' + Math.random().toString(16).slice(2)); }

  // Minimal QR generator (adapted from qrcode-generator style logic; embedded to avoid external services)
  // Supports byte mode, error correction level M.
  function renderQrToCanvas(canvasId, text){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const qr = QrCode.encodeText(text);
    const cells = qr.cells;
    const n = cells.length;

    const pad = 10;
    const size = Math.min(canvas.width, canvas.height);
    const cell = Math.floor((size - pad*2) / n);
    const offset = Math.floor((size - cell*n) / 2);

    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,size,size);
    ctx.fillStyle = '#000';

    for (let r=0;r<n;r++){
      for (let c=0;c<n;c++){
        if (cells[r][c]) ctx.fillRect(offset + c*cell, offset + r*cell, cell, cell);
      }
    }
  }

  const QrCode = (()=>{
    // Very small QR encoder for Version 4 (33x33) byte-mode only.
    // This is enough for Solana Pay URLs used here.
    function encodeText(text){
      const bytes = new TextEncoder().encode(text);
      // Version 4 capacity (M) in byte mode: 64 bytes. If bigger, we'll truncate.
      const data = Array.from(bytes.slice(0, 64));
      const bits = [];
      const pushBits=(v,len)=>{ for(let i=len-1;i>=0;i--) bits.push((v>>i)&1); };

      // mode: byte (0100)
      pushBits(0b0100,4);
      // length for version 1-9: 8 bits
      pushBits(data.length,8);
      for(const b of data) pushBits(b,8);
      // terminator
      pushBits(0,4);
      while(bits.length % 8) bits.push(0);

      const codewords=[];
      for(let i=0;i<bits.length;i+=8){
        let b=0; for(let j=0;j<8;j++) b=(b<<1)|bits[i+j];
        codewords.push(b);
      }
      // pad to 64 data codewords for version 4-M (data cw = 64)
      const PAD=[0xEC,0x11];
      let pi=0;
      while(codewords.length<64){ codewords.push(PAD[pi++%2]); }

      // Add error correction (version 4-M: ec cw = 36). We use a simple RS implementation.
      const ec = reedSolomon(codewords, 36);
      const finalCw = codewords.concat(ec);

      // Build matrix
      const n=33;
      const m = Array.from({length:n},()=>Array(n).fill(null));
      const set=(r,c,v)=>{ if(r>=0&&c>=0&&r<n&&c<n) m[r][c]=v; };
      const placeFinder=(r,c)=>{
        for(let dr=-1;dr<=7;dr++) for(let dc=-1;dc<=7;dc++){
          const rr=r+dr, cc=c+dc;
          const on = (dr>=0&&dr<=6&&dc>=0&&dc<=6 && (dr===0||dr===6||dc===0||dc===6|| (dr>=2&&dr<=4&&dc>=2&&dc<=4)));
          set(rr,cc,on?1:0);
        }
      };
      placeFinder(0,0); placeFinder(0,n-7); placeFinder(n-7,0);
      // timing patterns
      for(let i=8;i<n-8;i++){ set(6,i,i%2===0?1:0); set(i,6,i%2===0?1:0); }
      // alignment (version 4: positions 6,26)
      placeAlign(26,26);
      function placeAlign(r,c){
        for(let dr=-2;dr<=2;dr++) for(let dc=-2;dc<=2;dc++){
          const on = Math.max(Math.abs(dr),Math.abs(dc))!==1;
          set(r+dr,c+dc,on?1:0);
        }
      }
      // dark module
      set(4*8+1,8,1);

      // reserve format info areas
      for(let i=0;i<9;i++){ if(m[8][i]===null) set(8,i,0); if(m[i][8]===null) set(i,8,0); }
      for(let i=n-8;i<n;i++){ if(m[8][i]===null) set(8,i,0); if(m[i][8]===null) set(i,8,0); }
      for(let i=0;i<8;i++){ if(m[n-1-i][8]===null) set(n-1-i,8,0); if(m[8][n-1-i]===null) set(8,n-1-i,0); }

      // data placement (mask 0)
      let bitIdx=0;
      const getBit=()=>{
        const cw=Math.floor(bitIdx/8);
        const b=finalCw[cw];
        const offset=7-(bitIdx%8);
        bitIdx++;
        return (b>>offset)&1;
      };
      let dir=-1;
      for(let c=n-1;c>0;c-=2){
        if(c===6) c--; // skip timing column
        for(let r= (dir===-1?n-1:0); dir===-1? r>=0 : r<n; r+=dir){
          for(let dc=0;dc<2;dc++){
            const cc=c-dc;
            if(m[r][cc]!==null) continue;
            const b = bitIdx < finalCw.length*8 ? getBit() : 0;
            // mask 0: (r+c)%2==0
            const masked = ((r+cc)%2===0) ? (b^1) : b;
            m[r][cc]=masked;
          }
        }
        dir*=-1;
      }

      // format info for level M, mask 0
      writeFormat(m, 'M', 0);

      // convert to boolean cells
      const cells = m.map(row=>row.map(v=>v?true:false));
      return { cells };
    }

    function writeFormat(m, level, mask){
      const n=m.length;
      const eclBits = level==='L'?1: level==='M'?0: level==='Q'?3:2;
      let format = (eclBits<<3) | mask;
      // BCH(15,5)
      let bch = format<<10;
      const poly = 0b10100110111;
      for(let i=14;i>=10;i--){
        if(((bch>>i)&1)===1) bch ^= poly<<(i-10);
      }
      const bits = ((format<<10)|bch) ^ 0b101010000010010;
      const bit = (i)=> (bits>>(14-i))&1;

      // place
      const set=(r,c,v)=>{ if(m[r][c]===null) m[r][c]=v; else m[r][c]=v; };
      // around top-left
      for(let i=0;i<=5;i++) set(8,i,bit(i));
      set(8,7,bit(6));
      set(8,8,bit(7));
      set(7,8,bit(8));
      for(let i=9;i<15;i++) set(14-i,8,bit(i));
      // top-right
      for(let i=0;i<8;i++) set(8,n-1-i,bit(i));
      // bottom-left
      for(let i=8;i<15;i++) set(n-15+i,8,bit(i));
    }

    // Reed-Solomon over GF(256)
    function reedSolomon(data, ecLen){
      const gfExp = new Array(512).fill(0);
      const gfLog = new Array(256).fill(0);
      let x=1;
      for(let i=0;i<255;i++){
        gfExp[i]=x;
        gfLog[x]=i;
        x<<=1;
        if(x&256) x^=0x11d;
      }
      for(let i=255;i<512;i++) gfExp[i]=gfExp[i-255];
      const mul=(a,b)=>{ if(a===0||b===0) return 0; return gfExp[gfLog[a]+gfLog[b]]; };

      let gen=[1];
      for(let i=0;i<ecLen;i++){
        const next=[1, gfExp[i]];
        const out=new Array(gen.length+1).fill(0);
        for(let j=0;j<gen.length;j++){
          out[j] ^= mul(gen[j], next[0]);
          out[j+1] ^= mul(gen[j], next[1]);
        }
        gen=out;
      }

      const msg = data.concat(new Array(ecLen).fill(0));
      for(let i=0;i<data.length;i++){
        const coef = msg[i];
        if(coef===0) continue;
        for(let j=0;j<gen.length;j++){
          msg[i+j] ^= mul(gen[j], coef);
        }
      }
      return msg.slice(msg.length-ecLen);
    }

    return { encodeText };
  })();

  let capabilities = null;
  let lastRequest = null;

  function setStatus(kind, html){
    const el = document.getElementById('status');
    el.innerHTML = `<div class="alert ${kind}">${html}</div>`;
  }

  function setPayBox(kind, html){
    const el = document.getElementById('payBox');
    el.className = `alert ${kind||''}`;
    el.innerHTML = html;
  }

  function setReceiptBox(kind, html){
    const el = document.getElementById('receiptBox');
    el.className = `alert ${kind||''}`;
    el.innerHTML = html;
  }

  async function loadCaps(){
    const res = await fetch('/.well-known/escalatex');
    capabilities = await res.json();

    const h = capabilities.provider?.handle || handle || 'provider';
    document.getElementById('endpointTag').textContent = `${baseUrl}/.well-known/escalatex • @${h}`;
    document.getElementById('profileBtn').href = `/@${encodeURIComponent(h)}`;

    const tierSel = document.getElementById('tier');
    tierSel.innerHTML = '';
    (capabilities.tiers || []).forEach((t, idx)=>{
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = `${t.label} — ${t.price?.amount} ${t.price?.currency}`;
      if (idx===0) opt.selected = true;
      tierSel.appendChild(opt);
    });
  }

  async function submitReq(){
    const idem = uuid();
    document.getElementById('submitBtn').disabled = true;

    try {
      const body = {
        subject: document.getElementById('subject').value,
        details: document.getElementById('details').value,
        desired_tier: document.getElementById('tier').value,
      };

      const r = await fetch('/.well-known/escalatex', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Idempotency-Key': idem },
        body: JSON.stringify(body),
      });

      const j = await r.json();
      lastRequest = j;

      if (r.status === 409 || j.status === 'busy') {
        setStatus('bad', `<strong>Busy</strong><div class="small">${esc(j.message || 'Provider unavailable')}</div>`);
        setPayBox('', `<div class="small">Try again later, or use an interrupt tier if offered.</div>`);
        return;
      }

      if (j.status === 'accepted') {
        setStatus('good', `<strong>Accepted</strong><div class="small">${esc(j.message || 'Request accepted.')}</div>`);
      }

      if (j.status === 'requires_payment') {
        const payUrl = j.payment?.pay_url;
        const receiptUrl = j.request?.receipt_url;

        setStatus('', `<strong>Payment required</strong><div class="small">Pay to escalate and notify the provider.</div>`);

        setReceiptBox('', `<div class="small">Receipt:</div><div class="row"><a class="mono" href="${esc(receiptUrl)}" target="_blank">${esc(receiptUrl)}</a><button class="btn" id="copyReceiptBtn" type="button">Copy</button></div>`);

        setPayBox('', `
          <div class="small">Amount:</div>
          <div><strong>${esc(j.payment?.amount)} ${esc(j.payment?.currency)}</strong></div>
          <div class="small" style="margin-top:8px">Solana Pay URL:</div>
          <div class="mono" id="payUrl" style="word-break:break-all">${esc(payUrl || '')}</div>
          <div style="margin-top:10px" class="row">
            <div class="alert" style="padding:10px">
              <div class="small">Scan to pay</div>
              <canvas id="qr" width="220" height="220" style="margin-top:8px;border-radius:12px;background:#fff"></canvas>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <a class="btn primary" href="${esc(payUrl || '#')}" target="_blank" ${payUrl?"":"style='pointer-events:none;opacity:.6'"}>Open payment link</a>
            <button class="btn" id="copyPayBtn" type="button">Copy link</button>
            <button class="btn" id="checkBtn" type="button">Check payment</button>
          </div>
          <div class="small" style="margin-top:10px">Have a tx signature?</div>
          <div class="row">
            <input id="txSig" placeholder="Paste tx signature" class="mono" />
            <button class="btn" id="confirmBtn" type="button">Confirm</button>
          </div>
        `);

        // wire buttons
        document.getElementById('checkBtn').onclick = checkPayment;
        document.getElementById('confirmBtn').onclick = confirmPaid;
        document.getElementById('copyReceiptBtn').onclick = async () => {
          try {
            await navigator.clipboard.writeText(receiptUrl || '');
            setStatus('good', `<strong>Copied</strong><div class="small">Receipt link copied to clipboard.</div>`);
          } catch {
            setStatus('bad', `<strong>Copy failed</strong><div class="small">Your browser blocked clipboard access.</div>`);
          }
        };
        document.getElementById('copyPayBtn').onclick = async () => {
          try {
            await navigator.clipboard.writeText(payUrl || '');
            setStatus('good', `<strong>Copied</strong><div class="small">Payment link copied to clipboard.</div>`);
          } catch {
            setStatus('bad', `<strong>Copy failed</strong><div class="small">Your browser blocked clipboard access.</div>`);
          }
        };

        // Render QR for Solana Pay URL (no external services)
        if (payUrl) {
          try { renderQrToCanvas('qr', payUrl); } catch {}
        }
      }

    } catch (e) {
      setStatus('bad', `<strong>Error</strong><div class="small">${esc(e.message || String(e))}</div>`);
    } finally {
      document.getElementById('submitBtn').disabled = false;
    }
  }

  async function checkPayment(){
    const id = lastRequest?.request?.id;
    if (!id) return;
    const r = await fetch(`/requests/${encodeURIComponent(id)}/check`, { method: 'POST' });
    const j = await r.json().catch(()=>({}));
    if (r.ok && j.status === 'paid') {
      setStatus('good', `<strong>Paid</strong><div class="small">Provider notified. Receipt: <a href="/r/${esc(id)}" target="_blank">/r/${esc(id)}</a></div>`);
      setPayBox('good', `<div><strong>Payment verified.</strong></div><div class="small">Tx: <span class="mono">${esc(j.receipt?.txSig || '')}</span></div>`);
      return;
    }
    setStatus('', `<strong>Awaiting payment</strong><div class="small">No matching tx found yet. Try again in ~10–20s.</div>`);
  }

  async function confirmPaid(){
    const id = lastRequest?.request?.id;
    const txSig = document.getElementById('txSig')?.value?.trim();
    if (!id || !txSig) return;
    const r = await fetch(`/requests/${encodeURIComponent(id)}/confirm-paid`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ txSig }),
    });
    const j = await r.json().catch(()=>({}));
    if (r.ok && j.status === 'paid') {
      setStatus('good', `<strong>Paid</strong><div class="small">Verified by signature.</div>`);
      setPayBox('good', `<div><strong>Payment verified.</strong></div><div class="small">Tx: <span class="mono">${esc(txSig)}</span></div>`);
      return;
    }
    setStatus('bad', `<strong>Verification failed</strong><div class="small">${esc(j.error || 'unknown_error')}</div>`);
  }

  document.getElementById('form').addEventListener('submit', (e)=>{
    e.preventDefault();
    submitReq();
  });

  document.getElementById('resetBtn').onclick = ()=>{
    document.getElementById('subject').value='';
    document.getElementById('details').value='';
    setStatus('', '');
    setPayBox('', '<div class="small">Submit a request to get a payment link/quote.</div>');
    setReceiptBox('', '<div class="small">Receipt link will appear after submit.</div>');
  };

  loadCaps().catch((e)=>{
    document.getElementById('endpointTag').textContent = 'Failed to load provider capabilities';
    setStatus('bad', esc(e.message || String(e)));
  });
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escalatex — Provider</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="h1" id="title">Escalatex</div>
          <div class="tag" id="subtitle">Protocol-first paid escalation inbox</div>
        </div>
      </div>
      <div class="row">
        <a class="btn ghost" href="/">Demo</a>
        <a class="btn primary" id="requestBtn" href="/request">Create request</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="h1" id="providerName">Loading…</div>
            <div class="tag mono" id="providerHandle"></div>
          </div>
          <span class="pill" id="protocolPill">escalatex/0.1</span>
        </div>

        <hr />

        <div class="kv" id="kv"></div>

        <hr />

        <div>
          <div class="h1" style="font-size:16px;margin-bottom:10px">Tiers</div>
          <div id="tiers" class="row" style="align-items:stretch"></div>
        </div>
      </div>

      <div class="card">
        <div class="h1" style="font-size:16px;margin-bottom:8px">Agent / dev quickstart</div>
        <div class="small">Discover capabilities:</div>
        <pre id="curlCap" class="mono"></pre>
        <div style="height:10px"></div>
        <div class="small">Create a request (idempotent):</div>
        <pre id="curlReq" class="mono"></pre>
        <div class="footer">Tip: use <span class="mono">Idempotency-Key</span> to safely retry.</div>
      </div>
    </div>

    <div class="footer">Escalatex is a protocol + reference implementation. Payments buy priority review/response SLA, not guaranteed completion.</div>
  </div>

<script>
  const wantedHandle = decodeURIComponent(location.pathname.slice(2)); // '/@handle'
  const baseUrl = location.origin;

  function esc(s){return String(s).replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

  async function main(){
    const res = await fetch('/.well-known/escalatex');
    const cap = await res.json();

    const handle = cap.provider?.handle || wantedHandle || 'provider';
    const display = cap.provider?.display_name || handle;

    document.title = `${display} — Escalatex`;
    document.getElementById('providerName').textContent = display;
    document.getElementById('providerHandle').textContent = `@${handle}`;

    document.getElementById('requestBtn').href = `/request?handle=${encodeURIComponent(handle)}`;

    const kv = document.getElementById('kv');
    const hours = cap.availability?.hours || {};
    kv.innerHTML = `
      <div>Endpoint</div><div class="mono">${esc(baseUrl)}/.well-known/escalatex</div>
      <div>Timezone</div><div>${esc(cap.provider?.timezone || 'UTC')}</div>
      <div>Hours</div><div>${esc((hours.days||[]).join(','))} ${esc(hours.start||'')}–${esc(hours.end||'')}</div>
      <div>Max open</div><div>${esc(cap.limits?.max_open_requests ?? '')}</div>
    `;

    const tiers = document.getElementById('tiers');
    tiers.innerHTML = '';
    (cap.tiers || []).forEach(t=>{
      const el = document.createElement('div');
      el.className = 'pill';
      el.style.alignItems = 'flex-start';
      el.style.flexDirection = 'column';
      el.style.gap = '4px';
      el.style.maxWidth = '100%';
      el.innerHTML = `
        <div style="color:var(--text);font-weight:800">${esc(t.label)}</div>
        <div class="small">${esc(t.price?.amount)} ${esc(t.price?.currency)} • ${esc(t.target)}</div>
        ${t.what_you_get ? `<div class="small">${esc(t.what_you_get)}</div>` : ''}
      `;
      tiers.appendChild(el);
    });

    const curlCap = document.getElementById('curlCap');
    curlCap.textContent = `curl -s ${baseUrl}/.well-known/escalatex | jq`;

    const curlReq = document.getElementById('curlReq');
    curlReq.textContent = `curl -s -X POST ${baseUrl}/.well-known/escalatex \\\n  -H 'Content-Type: application/json' \\\n  -H 'Idempotency-Key: <uuid>' \\\n  -d '{"subject":"Help me", "details":"…", "desired_tier":"24h"}' | jq`;
  }

  main().catch((e)=>{
    document.getElementById('providerName').textContent = 'Failed to load provider';
    document.getElementById('providerHandle').textContent = String(e);
  });
</script>
</body>
</html>
